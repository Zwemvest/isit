@page "/"
@using IsIt.Services
@using IsIt.Models
@using System.Text.Json
@inject QuizService QuizService
@inject IJSRuntime JS

<PageTitle>IsIt...?</PageTitle>

@if (_state == QuizState.Loading)
{
    <MudStack AlignItems="AlignItems.Center" Class="mt-8">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    </MudStack>
}
else if (_state == QuizState.Start)
{
    <MudStack AlignItems="AlignItems.Center" Spacing="6">
        <MudText Typo="Typo.h2" Align="Align.Center">IsIt...?</MudText>
        <MudText Typo="Typo.body1" Align="Align.Center" Color="Color.Secondary">
            Guess which categories each item belongs to.<br />
            Some items belong to multiple categories!
        </MudText>

        <MudToggleGroup T="GameMode" @bind-Value="_selectedGameMode" Color="Color.Primary" Style="width: 100%; max-width: 400px;">
            <MudToggleItem Value="GameMode.Daily" Text="Daily" />
            <MudToggleItem Value="GameMode.Custom" Text="Custom" />
        </MudToggleGroup>

        @if (_selectedGameMode == GameMode.Daily)
        {
            <MudPaper Class="pa-4" Style="width: 100%; max-width: 400px;">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.h6">Daily Challenge</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        @QuizService.GetDailyDateString()
                    </MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        Same 20 questions for everyone today. 6 random categories seeded by today's date.
                    </MudText>
                    @if (_dailyCompleted)
                    {
                        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Class="mt-2">
                            You've already completed today's daily!
                        </MudAlert>
                    }
                    else if (_dailyInProgress && _savedDailyResult != null)
                    {
                        <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined" Class="mt-2">
                            You have an in-progress daily (@_savedDailyResult.Answers.Count/@QuizService.DailyQuestions answered)
                        </MudAlert>
                    }
                </MudStack>
            </MudPaper>

            <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" OnClick="StartDailyGame"
                       Disabled="@_dailyCompleted">
                @(_dailyCompleted ? "Already Completed" : _dailyInProgress ? "Resume Daily" : "Start Daily")
            </MudButton>

            @if (_dailyCompleted && _savedDailyResult != null)
            {
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Size="Size.Medium" OnClick="ShowDailyResults">
                    View Today's Results
                </MudButton>
            }
        }
        else
        {
            <MudExpansionPanels Class="mt-4" Style="width: 100%; max-width: 400px;">
                <MudExpansionPanel Text="Settings">
                    <MudStack Spacing="4">
                        <MudText Typo="Typo.subtitle2">Scoring Mode</MudText>
                        <MudToggleGroup T="ScoringMode" @bind-Value="QuizService.ScoringMode" Color="Color.Primary" Style="width: 100%;">
                            <MudToggleItem Value="ScoringMode.AllCorrect" Text="All Correct" />
                            <MudToggleItem Value="ScoringMode.AnyCorrect" Text="Any Correct" />
                        </MudToggleGroup>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            @(QuizService.ScoringMode == ScoringMode.AllCorrect
                                ? "Must select all correct categories exactly"
                                : "At least one correct category counts as correct")
                        </MudText>

                        <MudDivider Class="my-2" />

                        <MudText Typo="Typo.subtitle2">Included Categories (min @QuizService.MinCategories)</MudText>
                        <MudSelect T="string" MultiSelection="true" SelectedValues="_selectedIncludedCategories"
                                   SelectedValuesChanged="OnCategoriesChanged"
                                   Label="Categories" Variant="Variant.Outlined"
                                   MultiSelectionTextFunc="@(list => $"{list.Count()} categories selected")">
                            @foreach (var cat in QuizService.AllCategories)
                            {
                                <MudSelectItem Value="@cat">
                                    <MudTooltip Text="@QuizService.CategoryTooltips[cat]" Placement="Placement.Right">
                                        <span>@QuizService.CategoryDisplayNames[cat]</span>
                                    </MudTooltip>
                                </MudSelectItem>
                            }
                        </MudSelect>
                        @if (_selectedIncludedCategories.Count() < QuizService.MinCategories)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Error">
                                Select at least @QuizService.MinCategories categories
                            </MudText>
                        }
                    </MudStack>
                </MudExpansionPanel>
            </MudExpansionPanels>

            <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" OnClick="StartGame"
                       Disabled="@(_selectedIncludedCategories.Count() < QuizService.MinCategories)">
                Start Custom Quiz
            </MudButton>
        }
    </MudStack>
}
else if (_state == QuizState.Playing)
{
    var item = QuizService.GetCurrentItem();
    if (item != null)
    {
        <MudStack Spacing="4">
            @* Fixed-width result box for previous answer with scrollbar *@
            <MudPaper Style="height: 200px; width: 100%; overflow-y: auto;" Elevation="0" Class="pa-2">
                @if (_lastAnswerItem != null)
                {
                    var includedCategories = _lastAnswerItem.Categories.Where(c => QuizService.IncludedCategories.Contains(c.Category)).ToList();

                    // Compute summary lists
                    var correctSelected = includedCategories.Where(c => c.Result == ResultType.Correct && _lastAnswerSelectedCategories.Contains(c.Category)).ToList();
                    var arguableSelected = includedCategories.Where(c => c.Result == ResultType.Arguable && _lastAnswerSelectedCategories.Contains(c.Category)).ToList();
                    var obscureSelected = includedCategories.Where(c => c.Result == ResultType.Obscure && _lastAnswerSelectedCategories.Contains(c.Category)).ToList();
                    var correctMissed = includedCategories.Where(c => c.Result == ResultType.Correct && !_lastAnswerSelectedCategories.Contains(c.Category)).ToList();
                    var missSelected = includedCategories.Where(c => c.Result == ResultType.Miss && _lastAnswerSelectedCategories.Contains(c.Category)).ToList();
                    var errorSelected = QuizService.IncludedCategories.Where(c => _lastAnswerSelectedCategories.Any(ic => ic == c) && _lastAnswerItem.Categories.All(lc => lc.Category != c)).ToList();
                    var misses = correctMissed.Select(c => c.Category).Concat(missSelected.Select(c => c.Category)).Concat(errorSelected).ToList();

                                        <MudText Typo="Typo.h6" Class="mb-2">@_lastAnswerItem.Name</MudText>

                    @* Summary header showing how the answer was counted *@
                    <MudAlert Severity="@(_lastAnswerResult == AnswerResult.Correct ? Severity.Success : Severity.Error)"
                              Variant="Variant.Filled" Dense="true" Class="mb-2">
                        <strong>@(_lastAnswerResult == AnswerResult.Correct ? "Correct!" : "Incorrect")</strong>
                        <MudStack Spacing="0" Class="mt-1" Style="font-size: 0.85em; font-weight: normal;">
                            @if (correctSelected.Any())
                            {
                                <span>Correct: @string.Join(", ", correctSelected.Select(c => QuizService.CategoryDisplayNames[c.Category]))</span>
                            }
                            @if (arguableSelected.Any())
                            {
                                <span>Arguable: @string.Join(", ", correctSelected.Select(c => QuizService.CategoryDisplayNames[c.Category]))</span>
                            }
                            @if (obscureSelected.Any())
                            {
                                <span>Obscure: @string.Join(", ", correctSelected.Select(c => QuizService.CategoryDisplayNames[c.Category]))</span>
                            }
                            @if (misses.Any())
                            {
                                <span>Miss: @string.Join(", ", misses.Select(c => QuizService.CategoryDisplayNames[c]))</span>
                            }
                        </MudStack>
                    </MudAlert>

                    <MudStack Spacing="2">
                        @* Correct categories that WERE selected - SUCCESS *@
                        @foreach (var cat in includedCategories.Where(c => c.Result == ResultType.Correct && _lastAnswerSelectedCategories.Contains(c.Category)))
                        {
                            <MudAlert Severity="Severity.Success" Variant="Variant.Outlined" Dense="true">
                                <strong>@QuizService.CategoryDisplayNames[cat.Category]</strong><br />
                                <span style="font-weight: normal;">@cat.Description</span>
                            </MudAlert>
                        }
                        @* Arguable categories that WERE selected - WARNING with warning icon *@
                        @foreach (var cat in includedCategories.Where(c => c.Result == ResultType.Arguable && _lastAnswerSelectedCategories.Contains(c.Category)))
                        {
                            <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined" Dense="true" Icon="@Icons.Material.Filled.Warning">
                                <strong>@QuizService.CategoryDisplayNames[cat.Category]</strong><br />
                                <span style="font-weight: normal;">@cat.Description</span>
                            </MudAlert>
                        }
                        @* Obscure categories that WERE selected - WARNING with info/exclamation icon *@
                        @foreach (var cat in includedCategories.Where(c => c.Result == ResultType.Obscure && _lastAnswerSelectedCategories.Contains(c.Category)))
                        {
                            <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined" Dense="true" Icon="@Icons.Material.Filled.Info">
                                <strong>@QuizService.CategoryDisplayNames[cat.Category]</strong><br />
                                <span style="font-weight: normal;">@cat.Description</span>
                            </MudAlert>
                        }
                        @* Correct categories that were NOT selected - ERROR (missed!) *@
                        @foreach (var cat in includedCategories.Where(c => c.Result == ResultType.Correct && !_lastAnswerSelectedCategories.Contains(c.Category)))
                        {
                            <MudAlert Severity="Severity.Error" Variant="Variant.Outlined" Dense="true">
                                <strong>@QuizService.CategoryDisplayNames[cat.Category] (Missed!)</strong><br />
                                <span style="font-weight: normal;">@cat.Description</span>
                            </MudAlert>
                        }
                        @* Miss categories that WERE selected - ERROR *@
                        @foreach (var cat in includedCategories.Where(c => c.Result == ResultType.Miss && _lastAnswerSelectedCategories.Contains(c.Category)))
                        {
                            <MudAlert Severity="Severity.Error" Variant="Variant.Outlined" Dense="true">
                                <strong>@QuizService.CategoryDisplayNames[cat.Category]</strong>
                                @if (!string.IsNullOrEmpty(cat.Description))
                                {
                                    <br /><span style="font-weight: normal;">@cat.Description</span>
                                }
                            </MudAlert>
                        }
                        @* Just wrong *@
                        @foreach (var cat in errorSelected)
                        {
                            <MudAlert Severity="Severity.Error" Variant="Variant.Outlined" Dense="true">
                                <strong>@QuizService.CategoryDisplayNames[cat]</strong>
                            </MudAlert>
                        }
                    </MudStack>
                }
                else
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center" Class="mt-8">
                        Answer questions to see results here
                    </MudText>
                }
            </MudPaper>

            <MudDivider />

            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    @if (QuizService.CurrentGameMode == GameMode.Daily)
                    {
                        <span>Question @QuizService.CurrentQuestionNumber of @QuizService.DailyQuestions (Daily)</span>
                    }
                    else if (QuizService.HasReachedMinQuestions)
                    {
                        <span>Question @QuizService.CurrentQuestionNumber / Endless</span>
                    }
                    else
                    {
                        <span>Question @QuizService.CurrentQuestionNumber of @QuizService.MinQuestionsForResults</span>
                    }
                </MudText>
                @if (QuizService.CurrentGameMode == GameMode.Custom)
                {
                    <MudButton
                        Variant="Variant.Outlined"
                        Color="Color.Primary"
                        Size="Size.Small"
                        Disabled="@(!QuizService.HasReachedMinQuestions)"
                        OnClick="ShowResults">
                        Show Results
                    </MudButton>
                }
            </MudStack>

            <MudText Typo="Typo.h3" Align="Align.Center" Class="my-2">@item.Name</MudText>

            <MudText Typo="Typo.h6" Color="Color.Secondary">Is it...</MudText>

            <MudStack Spacing="2">
                @foreach (var category in QuizService.IncludedCategories.OrderBy(c => QuizService.AllCategories.IndexOf(c)))
                {
                    var isSelected = _selectedCategories.Contains(category);
                    <MudButton
                        Variant="@(isSelected ? Variant.Filled : Variant.Outlined)"
                        Color="@(isSelected ? Color.Primary : Color.Default)"
                        FullWidth="true"
                        OnClick="() => ToggleCategory(category)">
                        @QuizService.CategoryDisplayNames[category]
                        <MudTooltip Text="@QuizService.CategoryTooltips[category]" Placement="Placement.End">
                            <MudIcon Icon=@Icons.Material.Outlined.Info></MudIcon>
                        </MudTooltip>
                    </MudButton>
                }
            </MudStack>

            <MudButton
                Variant="Variant.Filled"
                Color="Color.Success"
                FullWidth="true"
                Class="mt-4"
                Disabled="@(_selectedCategories.Count == 0)"
                OnClick="SubmitAnswer">
                Submit
            </MudButton>
        </MudStack>
    }
}
else if (_state == QuizState.Finished)
{
    // Use saved results when viewing previously completed daily, otherwise use QuizService
    var score = _viewingSavedResults && _savedDailyResult != null
        ? _savedDailyResult.Score
        : QuizService.Score;
    var questionsAnswered = _viewingSavedResults && _savedDailyResult != null
        ? _savedDailyResult.TotalQuestions
        : QuizService.AnswerHistory.Count;
    var percentage = questionsAnswered > 0
        ? (int)Math.Round(100.0 * score / questionsAnswered)
        : 0;

    <MudStack AlignItems="AlignItems.Center" Spacing="4">
        @* Show the last answer result at the top (only if not viewing saved results) *@
        @if (_lastAnswerItem != null && !_viewingSavedResults)
        {
            var includedCategories = _lastAnswerItem.Categories.Where(c => QuizService.IncludedCategories.Contains(c.Category)).ToList();

            <MudPaper Style="width: 100%; max-width: 500px;" Elevation="0" Class="pa-3">
                <MudAlert Severity="@GetResultSeverity()" Variant="Variant.Filled" Dense="true" Class="mb-2">
                    <strong>@_lastAnswerItem.Name:</strong> @string.Join(", ", includedCategories.Where(c => c.Result == ResultType.Correct || c.Result == ResultType.Arguable || c.Result == ResultType.Obscure).Select(c => QuizService.CategoryDisplayNames[c.Category]))
                </MudAlert>
                <MudStack Spacing="1">
                    @foreach (var category in includedCategories.Where(c => c.Result == ResultType.Correct))
                    {
                        <MudText Typo="Typo.body2" Style="opacity: 0.9;">
                            <strong>@QuizService.CategoryDisplayNames[category.Category]:</strong> @category.Description
                        </MudText>
                    }
                    @{
                        var finishedArguableCategories = includedCategories.Where(c => c.Result == ResultType.Arguable || c.Result == ResultType.Obscure).ToList();
                    }
                    @if (finishedArguableCategories.Count > 0)
                    {
                        <MudExpansionPanels Dense="true" Class="mt-1" Style="background: transparent;">
                            <MudExpansionPanel Text="Also acceptable..." Dense="true" Style="font-size: 0.875rem;">
                                @foreach (var category in finishedArguableCategories)
                                {
                                    <MudText Typo="Typo.body2" Style="opacity: 0.9;">
                                        <strong>@QuizService.CategoryDisplayNames[category.Category]:</strong> @category.Description
                                    </MudText>
                                }
                            </MudExpansionPanel>
                        </MudExpansionPanels>
                    }
                    @if (_lastAnswerMissedCategories != null && _lastAnswerMissedCategories.Count > 0)
                    {
                        @foreach (var missedCat in _lastAnswerMissedCategories)
                        {
                            var missEntry = includedCategories.FirstOrDefault(c => c.Category == missedCat && c.Result == ResultType.Miss);
                            @if (missEntry != null)
                            {
                                <MudText Typo="Typo.body2" Color="Color.Error" Style="opacity: 0.9;">
                                    <strong>@QuizService.CategoryDisplayNames[missEntry.Category] (Wrong!):</strong> @missEntry.Description
                                </MudText>
                            }
                        }
                    }
                </MudStack>
            </MudPaper>
            <MudDivider Style="width: 100%; max-width: 500px;" />
        }

        @if (QuizService.CurrentGameMode == GameMode.Daily)
        {
            <MudText Typo="Typo.h3">Daily Complete!</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">@QuizService.GetDailyDateString()</MudText>
        }
        else
        {
            <MudText Typo="Typo.h3">Quiz Complete!</MudText>
        }

        <MudText Typo="Typo.h1" Color="Color.Primary">
            @score / @questionsAnswered
        </MudText>

        <MudText Typo="Typo.h5" Color="Color.Secondary">@percentage% correct</MudText>

        <MudText Typo="Typo.body1" Class="mt-4">
            @GetScoreMessage(percentage)
        </MudText>

        @if (_viewingSavedResults || QuizService.CurrentGameMode == GameMode.Daily)
        {
            var streak = GetCurrentStreak();
            @if (streak > 0)
            {
                <MudPaper Class="pa-3 mt-4" Elevation="1" Style="background: linear-gradient(135deg, #ff9800 0%, #f44336 100%);">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.Whatshot" Style="color: white;" />
                        <MudText Typo="Typo.h6" Style="color: white;">
                            @streak day streak!
                        </MudText>
                        <MudIcon Icon="@Icons.Material.Filled.Whatshot" Style="color: white;" />
                    </MudStack>
                </MudPaper>
            }
        }

        <MudStack Row="true" Spacing="2" Class="mt-4">
            <MudButton
                Variant="Variant.Filled"
                Color="Color.Primary"
                Size="Size.Large"
                OnClick="BackToStart">
                @(QuizService.CurrentGameMode == GameMode.Daily ? "Back to Menu" : "Play Again")
            </MudButton>
            <MudButton
                Variant="Variant.Outlined"
                Color="Color.Secondary"
                Size="Size.Large"
                StartIcon="@Icons.Material.Filled.Share"
                OnClick="ShareResults">
                Share
            </MudButton>
        </MudStack>

        @if (_showCopiedMessage)
        {
            <MudAlert Severity="Severity.Success" Variant="Variant.Text" Dense="true">
                Copied to clipboard!
            </MudAlert>
        }

        @* Answer Review Section - works with both live answers and saved answers *@
        @if (QuizService.AnswerHistory.Count > 0 || (_viewingSavedResults && _savedDailyResult?.Answers.Count > 0))
        {
            <MudExpansionPanels Class="mt-4" Style="width: 100%; max-width: 600px;">
                <MudExpansionPanel Text="Review All Answers">
                    <MudStack Spacing="2">
                        @if (_viewingSavedResults && _savedDailyResult != null)
                        {
                            @foreach (var (answer, index) in _savedDailyResult.Answers.Select((a, i) => (a, i)))
                            {
                                var acceptableKeys = answer.ArguableCategories.Concat(answer.ObscureCategories).ToHashSet();
                                var correctDescs = answer.CategoryDescriptions.Where(d => !acceptableKeys.Contains(d.Key)).ToList();
                                var acceptableDescs = answer.CategoryDescriptions.Where(d => acceptableKeys.Contains(d.Key)).ToList();

                                <MudPaper Class="pa-3" Elevation="1">
                                    <MudStack Spacing="1">
                                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                            <MudText Typo="Typo.subtitle1">
                                                <strong>@(index + 1). @answer.ItemName</strong>
                                            </MudText>
                                            @if (answer.WasCorrect)
                                            {
                                                <MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" />
                                            }
                                            else
                                            {
                                                <MudIcon Icon="@Icons.Material.Filled.Close" Color="Color.Error" />
                                            }
                                        </MudStack>
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                                            <strong>Correct:</strong> @string.Join(", ", answer.CorrectCategories.Select(c => QuizService.CategoryDisplayNames.GetValueOrDefault(c, c)))
                                        </MudText>
                                        @if (!answer.WasCorrect)
                                        {
                                            <MudText Typo="Typo.body2" Color="Color.Error">
                                                <strong>You said:</strong> @(answer.SelectedCategories.Count > 0 ? string.Join(", ", answer.SelectedCategories.Select(c => QuizService.CategoryDisplayNames.GetValueOrDefault(c, c))) : "(none)")
                                            </MudText>
                                        }
                                        @foreach (var desc in correctDescs)
                                        {
                                            <MudText Typo="Typo.caption" Style="opacity: 0.8;">
                                                <strong>@QuizService.CategoryDisplayNames.GetValueOrDefault(desc.Key, desc.Key):</strong> @desc.Value
                                            </MudText>
                                        }
                                        @if (acceptableDescs.Count > 0)
                                        {
                                            <MudExpansionPanels Dense="true" Class="mt-1" Style="background: transparent;">
                                                <MudExpansionPanel Text="Also acceptable..." Dense="true" Style="font-size: 0.75rem;">
                                                    @foreach (var desc in acceptableDescs)
                                                    {
                                                        <MudText Typo="Typo.caption" Style="opacity: 0.8;">
                                                            <strong>@QuizService.CategoryDisplayNames.GetValueOrDefault(desc.Key, desc.Key):</strong> @desc.Value
                                                        </MudText>
                                                    }
                                                </MudExpansionPanel>
                                            </MudExpansionPanels>
                                        }
                                    </MudStack>
                                </MudPaper>
                            }
                        }
                        else
                        {
                            @foreach (var (answer, index) in QuizService.AnswerHistory.Select((a, i) => (a, i)))
                            {
                                var itemCategories = answer.Item.Categories.Where(c => QuizService.IncludedCategories.Contains(c.Category)).ToList();
                                var correctCats = itemCategories.Where(c => c.Result == ResultType.Correct).ToList();
                                var acceptableCats = itemCategories.Where(c => c.Result == ResultType.Arguable || c.Result == ResultType.Obscure).ToList();

                                <MudPaper Class="pa-3" Elevation="1">
                                    <MudStack Spacing="1">
                                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                            <MudText Typo="Typo.subtitle1">
                                                <strong>@(index + 1). @answer.Item.Name</strong>
                                            </MudText>
                                            @if (answer.WasCorrect)
                                            {
                                                <MudIcon Icon="@Icons.Material.Filled.Check" Color="Color.Success" />
                                            }
                                            else
                                            {
                                                <MudIcon Icon="@Icons.Material.Filled.Close" Color="Color.Error" />
                                            }
                                        </MudStack>
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                                            <strong>Correct:</strong> @string.Join(", ", answer.CorrectCategories.Select(c => QuizService.CategoryDisplayNames[c]))
                                        </MudText>
                                        @if (!answer.WasCorrect)
                                        {
                                            <MudText Typo="Typo.body2" Color="Color.Error">
                                                <strong>You said:</strong> @(answer.SelectedCategories.Count > 0 ? string.Join(", ", answer.SelectedCategories.Select(c => QuizService.CategoryDisplayNames[c])) : "(none)")
                                            </MudText>
                                        }
                                        @foreach (var cat in correctCats)
                                        {
                                            <MudText Typo="Typo.caption" Style="opacity: 0.8;">
                                                <strong>@QuizService.CategoryDisplayNames[cat.Category]:</strong> @cat.Description
                                            </MudText>
                                        }
                                        @if (acceptableCats.Count > 0)
                                        {
                                            <MudExpansionPanels Dense="true" Class="mt-1" Style="background: transparent;">
                                                <MudExpansionPanel Text="Also acceptable..." Dense="true" Style="font-size: 0.75rem;">
                                                    @foreach (var cat in acceptableCats)
                                                    {
                                                        <MudText Typo="Typo.caption" Style="opacity: 0.8;">
                                                            <strong>@QuizService.CategoryDisplayNames[cat.Category]:</strong> @cat.Description
                                                        </MudText>
                                                    }
                                                </MudExpansionPanel>
                                            </MudExpansionPanels>
                                        }
                                    </MudStack>
                                </MudPaper>
                            }
                        }
                    </MudStack>
                </MudExpansionPanel>
            </MudExpansionPanels>
        }
    </MudStack>
}

@code {
    private enum QuizState { Loading, Start, Playing, Finished }
    private enum AnswerResult { None, Correct, Wrong }

    private QuizState _state = QuizState.Loading;
    private HashSet<string> _selectedCategories = [];

    // Last answer tracking for the result box
    private QuizItem? _lastAnswerItem;
    private AnswerResult _lastAnswerResult = AnswerResult.None;
    private HashSet<string>? _lastAnswerMissedCategories;
    private HashSet<string> _lastAnswerSelectedCategories = [];

    // Settings
    private IEnumerable<string> _selectedIncludedCategories = [];
    private GameMode _selectedGameMode = GameMode.Daily;

    // Daily mode tracking
    private bool _dailyCompleted;
    private bool _dailyInProgress;
    private DailyResult? _savedDailyResult;
    private bool _viewingSavedResults;
    private List<DailyHistoryEntry> _dailyHistory = [];

    // Share functionality
    private bool _showCopiedMessage;

    private const string DailyResultKey = "isit_daily_result";
    private const string DailyHistoryKey = "isit_daily_history";
    private const string GitHubPagesUrl = "https://zwemvest.github.io/isit";

    protected override async Task OnInitializedAsync()
    {
        await QuizService.LoadItemsAsync();
        // Initialize the UI selection from the service's defaults
        _selectedIncludedCategories = QuizService.IncludedCategories.ToList();
        _state = QuizState.Start;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await CheckDailyCompletion();
            StateHasChanged();
        }
    }

    private async Task CheckDailyCompletion()
    {
        try
        {
            // Load today's result
            var json = await JS.InvokeAsync<string?>("localStorage.getItem", DailyResultKey);
            if (!string.IsNullOrEmpty(json))
            {
                _savedDailyResult = JsonSerializer.Deserialize<DailyResult>(json);
                if (_savedDailyResult != null && _savedDailyResult.Date == QuizService.GetDailyDateString())
                {
                    if (_savedDailyResult.IsCompleted)
                    {
                        _dailyCompleted = true;
                    }
                    else
                    {
                        // In-progress daily quiz - restore and resume
                        _dailyInProgress = true;
                    }
                }
                else
                {
                    // Old result from previous day - clear it
                    _savedDailyResult = null;
                    _dailyCompleted = false;
                }
            }

            // Load history for streak tracking
            var historyJson = await JS.InvokeAsync<string?>("localStorage.getItem", DailyHistoryKey);
            if (!string.IsNullOrEmpty(historyJson))
            {
                _dailyHistory = JsonSerializer.Deserialize<List<DailyHistoryEntry>>(historyJson) ?? [];
            }
        }
        catch
        {
            // localStorage not available or other error
        }
    }

    private async Task SaveDailyProgress()
    {
        if (QuizService.CurrentGameMode != GameMode.Daily) return;

        var result = BuildDailyResult();

        try
        {
            var json = JsonSerializer.Serialize(result);
            await JS.InvokeVoidAsync("localStorage.setItem", DailyResultKey, json);
            _savedDailyResult = result;
        }
        catch
        {
            // localStorage not available
        }
    }

    private async Task SaveDailyResult()
    {
        var result = BuildDailyResult();

        try
        {
            // Save today's detailed result
            var json = JsonSerializer.Serialize(result);
            await JS.InvokeVoidAsync("localStorage.setItem", DailyResultKey, json);
            _savedDailyResult = result;
            _dailyCompleted = true;

            // Add to history (only date + score)
            var historyEntry = new DailyHistoryEntry
            {
                Date = result.Date,
                Score = result.Score,
                TotalQuestions = result.TotalQuestions
            };

            // Remove any existing entry for today (shouldn't happen, but just in case)
            _dailyHistory.RemoveAll(h => h.Date == result.Date);
            _dailyHistory.Add(historyEntry);

            // Save updated history
            var historyJson = JsonSerializer.Serialize(_dailyHistory);
            await JS.InvokeVoidAsync("localStorage.setItem", DailyHistoryKey, historyJson);
        }
        catch
        {
            // localStorage not available
        }
    }

    private DailyResult BuildDailyResult()
    {
        return new DailyResult
        {
            Date = QuizService.GetDailyDateString(),
            Score = QuizService.Score,
            TotalQuestions = QuizService.DailyQuestions,
            Categories = QuizService.IncludedCategories.ToList(),
            Answers = QuizService.AnswerHistory.Select(a => new SavedAnswer
            {
                ItemName = a.Item.Name,
                CorrectCategories = a.CorrectCategories.ToList(),
                ArguableCategories = a.Item.Categories
                    .Where(c => QuizService.IncludedCategories.Contains(c.Category) && c.Result == ResultType.Arguable)
                    .Select(c => c.Category)
                    .ToList(),
                ObscureCategories = a.Item.Categories
                    .Where(c => QuizService.IncludedCategories.Contains(c.Category) && c.Result == ResultType.Obscure)
                    .Select(c => c.Category)
                    .ToList(),
                SelectedCategories = a.SelectedCategories.ToList(),
                WasCorrect = a.WasCorrect,
                Explanation = "", // Deprecated - now using CategoryDescriptions
                CategoryDescriptions = QuizService.GetCategoryDescriptions(a.Item)
            }).ToList()
        };
    }

    private void OnCategoriesChanged(IEnumerable<string> categories)
    {
        _selectedIncludedCategories = categories;
        if (categories.Count() >= QuizService.MinCategories)
        {
            QuizService.SetIncludedCategories(categories);
        }
    }

    private void StartGame()
    {
        QuizService.StartNewGame();
        _selectedCategories.Clear();
        _lastAnswerItem = null;
        _lastAnswerResult = AnswerResult.None;
        _lastAnswerSelectedCategories.Clear();
        _state = QuizState.Playing;
    }

    private void StartDailyGame()
    {
        if (_dailyInProgress && _savedDailyResult != null)
        {
            // Resume from saved progress
            QuizService.RestoreDailyGame(_savedDailyResult.Answers.Count, _savedDailyResult.Score);
            _dailyInProgress = false; // Clear flag since we're now actively playing
        }
        else
        {
            QuizService.StartDailyGame();
        }

        _selectedCategories.Clear();
        _lastAnswerItem = null;
        _lastAnswerResult = AnswerResult.None;
        _lastAnswerSelectedCategories.Clear();
        _state = QuizState.Playing;
    }

    private void ShowDailyResults()
    {
        if (_savedDailyResult != null)
        {
            _viewingSavedResults = true;
            _state = QuizState.Finished;
        }
    }

    private void BackToStart()
    {
        _state = QuizState.Start;
        _lastAnswerItem = null;
        _lastAnswerResult = AnswerResult.None;
        _lastAnswerSelectedCategories.Clear();
        _selectedCategories.Clear();
        _viewingSavedResults = false;
    }

    private void ToggleCategory(string category)
    {
        if (!_selectedCategories.Remove(category))
        {
            _selectedCategories.Add(category);
        }
    }

    private async Task SubmitAnswer()
    {
        // Store current item and selected categories before moving on
        _lastAnswerItem = QuizService.GetCurrentItem();
        _lastAnswerSelectedCategories = [.. _selectedCategories];

        // Check answer and determine result type
        var isCorrect = QuizService.CheckAnswer(_selectedCategories);

        // Get the last answer record to check for missed categories
        var lastRecord = QuizService.AnswerHistory.LastOrDefault();
        _lastAnswerMissedCategories = lastRecord?.MissedCategories;

        _lastAnswerResult = isCorrect ? AnswerResult.Correct : AnswerResult.Wrong;

        // Move to next question immediately
        QuizService.MoveToNext();
        _selectedCategories.Clear();

        // Check if daily is complete
        if (QuizService.IsDailyComplete)
        {
            await SaveDailyResult();
            _state = QuizState.Finished;
        }
        // Only auto-finish custom mode when we've run out of questions entirely
        else if (QuizService.CurrentGameMode == GameMode.Custom && QuizService.IsFinished)
        {
            _state = QuizState.Finished;
        }
        else if (QuizService.CurrentGameMode == GameMode.Daily)
        {
            // Save progress after each answer in daily mode
            await SaveDailyProgress();
        }
    }

    private void ShowResults()
    {
        _state = QuizState.Finished;
    }

    private async Task ShareResults()
    {
        // Use saved results when viewing previously completed daily
        var score = _viewingSavedResults && _savedDailyResult != null
            ? _savedDailyResult.Score
            : QuizService.Score;
        var questionsAnswered = _viewingSavedResults && _savedDailyResult != null
            ? _savedDailyResult.TotalQuestions
            : QuizService.AnswerHistory.Count;
        var percentage = questionsAnswered > 0
            ? (int)Math.Round(100.0 * score / questionsAnswered)
            : 0;

        // Generate emoji grid (like Wordle)
        var emojiGrid = GenerateEmojiGrid(score, questionsAnswered);

        // Build the share text
        var shareText = (_viewingSavedResults || QuizService.CurrentGameMode == GameMode.Daily)
            ? $"IsIt...? Daily {QuizService.GetDailyDateString()}\n"
            : $"IsIt...? Custom Quiz\n";

        shareText += $"{score}/{questionsAnswered} ({percentage}%)\n\n";
        shareText += emojiGrid + "\n\n";
        shareText += GitHubPagesUrl;

        // If Custom mode (not viewing saved daily), add URL parameters
        if (!_viewingSavedResults && QuizService.CurrentGameMode == GameMode.Custom)
        {
            var categories = string.Join(",", QuizService.IncludedCategories);
            shareText += $"?mode=custom&cats={Uri.EscapeDataString(categories)}";
        }

        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", shareText);
            _showCopiedMessage = true;
            StateHasChanged();

            // Hide message after 2 seconds
            await Task.Delay(2000);
            _showCopiedMessage = false;
            StateHasChanged();
        }
        catch
        {
            // Clipboard API not available
        }
    }

    private string GenerateEmojiGrid(int score, int questionsAnswered)
    {
        // We don't track individual answers, so we'll show a simple score representation
        var rows = new List<string>();

        // Show results in rows of 5
        for (int i = 0; i < questionsAnswered && i < 20; i += 5)
        {
            var row = "";
            for (int j = 0; j < 5 && (i + j) < questionsAnswered && (i + j) < 20; j++)
            {
                // Simple visualization: green squares for correct answers, red for incorrect
                // Since we don't track individual answers, we'll approximate based on score percentage
                var questionIndex = i + j;
                if (questionIndex < score)
                {
                    row += "\ud83d\udfe9"; // Green square
                }
                else
                {
                    row += "\ud83d\udfe5"; // Red square
                }
            }
            rows.Add(row);
        }

        return string.Join("\n", rows);
    }

    private Severity GetResultSeverity() => _lastAnswerResult switch
    {
        AnswerResult.Correct => Severity.Success,
        _ => Severity.Error
    };

    private static string GetScoreMessage(int percentage) => percentage switch
    {
        >= 90 => "Outstanding! You really know your stuff!",
        >= 70 => "Great job! You've got a sharp eye!",
        >= 50 => "Not bad! Room for improvement though.",
        _ => "Keep practicing! You'll get better!"
    };

    private int GetCurrentStreak()
    {
        if (_dailyHistory.Count == 0) return 0;

        // Sort by date descending (most recent first)
        var sortedHistory = _dailyHistory
            .OrderByDescending(h => h.Date)
            .ToList();

        var streak = 0;
        var expectedDate = DateTime.UtcNow.Date;

        foreach (var entry in sortedHistory)
        {
            if (!DateTime.TryParse(entry.Date, out var entryDate))
                continue;

            entryDate = entryDate.Date;

            // If this entry matches the expected date, increment streak
            if (entryDate == expectedDate)
            {
                streak++;
                expectedDate = expectedDate.AddDays(-1);
            }
            // If we haven't started counting yet and this is yesterday, start from there
            else if (streak == 0 && entryDate == expectedDate.AddDays(-1))
            {
                streak++;
                expectedDate = expectedDate.AddDays(-2);
            }
            // Gap in dates - streak is broken
            else if (entryDate < expectedDate)
            {
                break;
            }
        }

        return streak;
    }
}
